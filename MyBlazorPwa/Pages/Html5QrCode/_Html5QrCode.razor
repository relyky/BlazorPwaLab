@page "/html5qrcode"

<h3>Html5QrCode.v4</h3>
<button @onclick="HandleScanQrCode">可連續掃描QR Code</button>
<button @onclick="HandleStopScan">停止掃描</button>
<label>
    <input type="checkbox" @bind="f_readStop" />
    掃描成功後立刻停止掃描
</label>
<br />

<button @onclick="HandleScanQrCodeOnce">掃描QR Code</button>

<div style="width:600px; max-width:80vw; border:solid 1px darkgrey; background-color:lightgrey; padding:4px; margin: 8px 0; border-radius: 4px;">
    <div id="qrcodeReader" style="visibility:hidden"></div>
</div>

<p>qrCode(@scanCount):@qrCode</p>
<p>warnMsg(@warnCount):@warnMsg</p>
<p>errorMsg(@errorCount):@errorMsg</p>

@code{
    [Inject] IJSRuntime jsr { get; init; }

    #region Resource
    IJSObjectReference module;
    MyBlazor.RazorComponent.QrCodeInterop jsrQrCode;
    #endregion

    #region State
    string qrCode = null;
    int scanCount = 0;
    string warnMsg = null;
    int warnCount = 0;
    string errorMsg = null;
    int errorCount = 0;
    bool f_readStop = true;
    #endregion

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        // 動態載入 JS module
        module = await jsr.InvokeAsync<IJSObjectReference>("import", "./tools/qrcodeTools.js");
        jsrQrCode = new QrCodeInterop(jsr);
    }

    async void HandleScanQrCode()
    {
        scanCount = warnCount = errorCount = 0;
        await module.InvokeVoidAsync("scanQrCode", DotNetObjectReference.Create(this), "qrcodeReader", f_readStop);
    }

    async Task HandleScanQrCodeOnce()
    {
        scanCount = warnCount = errorCount = 0;
        //await module.InvokeVoidAsync("scanQrCodeOnce", DotNetObjectReference.Create(this), "qrcodeReader");

        qrCode = await jsrQrCode.ScanQrCodeOnce("qrcodeReader");
    }

    async void HandleStopScan()
    {
        await module.InvokeVoidAsync("stopScan", DotNetObjectReference.Create(this));
    }

    [JSInvokable]
    public Task<int> OnScanResponse(string type, string message)
    {
        switch (type)
        {
            case "SUCCESS":
                qrCode = message;
                scanCount++;
                break;
            case "WARN":
            case "STOP":
                warnMsg = message;
                warnCount++;
                break;
            default:
                errorMsg = message;
                errorCount++;
                break;
        }

        StateHasChanged();
        return Task.FromResult(0);
    }
}
