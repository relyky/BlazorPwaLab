@page "/html5camera"

<h3>Html5Camera.v3.0</h3>
<button @onclick="HandleStartCamera">啟動攝影機</button>
<button @onclick="HandleStopCamera">停止</button>
<p>message: @message</p>

@* needed to by the camera stream *@
<div class="@(f_openCamera ? "d-block" : "d-none") text-center" style="width:600px; max-width:90vw; margin:auto;">
    <video @ref="videoElement" style="width:100%; background-color:grey;" autoplay muted webkit-playsinline playsinline></video>
    <button class="btn btn-info" style="position:relative; bottom:50px; border-radius:50%;" @onclick="HandleTakePhoto">
        <span class="oi oi-camera-slr"></span>
    </button>
</div>

@* needed if you want to display the image when you take a photo *@
<img alt="photo picture" src="@photoDataUri" class="img-fluid img-thumbnail mx-auto d-block">

@code{
    [Inject] IJSRuntime jsr { get; init; }

    #region Resource
    IJSObjectReference module;
    DotNetObjectReference<Html5Camera> dotNetObject;
    ElementReference videoElement;
    #endregion

    #region State
    string photoDataUri = null;
    string message = null;
    bool f_openCamera = false;
    #endregion

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        // 動態載入 JS module
        module = await jsr.InvokeAsync<IJSObjectReference>("import", "./tools/cameraTools.js");
        dotNetObject = DotNetObjectReference.Create(this);
    }

    async Task HandleStartCamera()
    {
        f_openCamera = true;
        await module.InvokeVoidAsync("startCamera", dotNetObject, videoElement);
    }

    async Task HandleStopCamera()
    {
        await module.InvokeVoidAsync("stopCamera", dotNetObject);
        f_openCamera = false;
    }

    async Task HandleTakePhoto()
    {
        await module.InvokeVoidAsync("takePhoto", dotNetObject);
    }

    [JSInvokable]
    public Task<int> OnCameraResponse(string type, string _message)
    {
        switch (type)
        {
            case "SUCCESS":
                message = _message;
                break;
            case "STOP":
                message = _message;
                break;
            case "PHOTO":
                photoDataUri = _message;
                module.InvokeVoidAsync("stopCamera", dotNetObject);
                f_openCamera = false;
                break;
            default:
                message = _message;
                break;
        }

        StateHasChanged();
        return Task.FromResult(0);
    }
}
